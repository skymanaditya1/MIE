@using PagedList;
@using PagedList.Mvc;

@model PagedList.IPagedList<MecMauritius.Models.DigitalResources>

@{
    ViewBag.Title = "Download Space for Digital Repository of Resources";
}
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>@ViewBag.Title</title>
    <!-- Style required for displaying the resources-->
    <link rel="stylesheet" href="~/Content/StarRating/css/star-rating.css" media="all" type="text/css">
    <link rel="stylesheet" href="~/css/jquery.paginate.css" />
    <script src="~/Content/StarRating/js/star-rating.js" type="text/javascript"></script>
    <script src="~/js/jquery.paginate.js" type="text/javascript"></script>
    <link href="https://gitcdn.github.io/bootstrap-toggle/2.2.2/css/bootstrap-toggle.min.css" rel="stylesheet">
    <script src="https://gitcdn.github.io/bootstrap-toggle/2.2.2/js/bootstrap-toggle.min.js"></script>

    <style>
        .paginate {
            padding: 0;
            margin: 0;
        }

            .paginate > li {
                list-style: none;
                padding: 10px 20px;
                border: 1px solid #ddd;
                margin: 10px 0;
            }

         hr { width:100%; height:1px; background: #fff }

        .box {
            width: 180px;
            height: 320px;
            display: -moz-inline-stack;
            display: inline-block;
            vertical-align: top;
            zoom: 1;
            background: #F2FF8E;
            box-shadow: 0 4px 5px 0 rgba(0,0,0,0.14),0 1px 10px 0 rgba(0,0,0,0.12),0 2px 4px -1px rgba(0,0,0,0.3);
            margin: 10px;
            font-family: Arial,sans-serif;
        }

            .box img {
                width: 150px;
                height: 100px;
                margin-left: 22px;
            }

            .box .ratingText {
                font-size: 10px;
                float: left;
            }

            .box .downloads {
                font-size: 10px;
                float: right;
            }

            .box .downloadsText{
                font-size: 11px;
                float: right;
            }

            .box .ratings {
                font-size: 6px;
                float: left;
            }

            .box .content {
                padding: 10px;
                margin-top: 0px;
            }

            .box p {
                margin: 7px 0;
            }

            .box .title {
                color: #33B7FF;
                font-size: 15px;
                text-align: center;
            }

            .box .price {
                color: #FF4500;
                float: right;
                font-size: 12px;
            }

            .box .author {
                font-size: 10px;
                color: #FF4500;
            }

            a {
               font-size: 12px;
               margin-top: 5px;
            }

            .box .desc {
                font-size: 12px;
                color: #616161;
            }

        .horizontal {
            display: inline;
            background-color: aqua;
        }

        .cot {
            text-align: center;
        }
    </style>
</head>
<body>

    <!--Displays top content-->
    <div class="container">
        <video src="https://miemecstorage.blob.core.windows.net/mecmauritius/banner_resources.mp4" preload="auto" autoplay="autoplay" controls="controls" style="width:100%" muted="muted" loop="loop"></video>
    </div>

    <div class="container body-content">
        <div class="row">
            <div class="col-md-8">
                <ul style="background-color: rgb(238, 238, 238)" class="nav nav-tabs" id="ResourceTypeList">
                    <li role="presentation"><a href="#">All</a></li>
                    @foreach (var resourceType in ViewBag.ResourceTypes)
                    {
                        <li role="presentation"><a href="#">@resourceType.Title</a></li>
                    }
                </ul><br /><br />

                <p>
                    Specify Search Query : <input type="text" name="queryName" id="queryText" placeholder="Search Query" />
                    <!--<input type="submit" id="btnSubmit" value="Search Results" />-->
                    <a id="btnSubmit" class="btn btn-primary" role="button">Search Resources</a>
                </p>

                <!-- Display toggle only in case of educator and admin-->
                @if (ViewBag.displayUpload == "Yes")
                {
                    <label><input type="checkbox" data-toggle="toggle" id="showUploadedResources" /> &nbsp;Edit my Uploaded Resources</label>
                }

                <!--Displays the dropdowns for the Grades and Courses-->
                <div class="container">
                    <div class="row">
                        <div class="col-md-2" style="margin:20px;"><h5>Search By:</h5></div>

                        <div class="col-md-1 col-md-pull-1" style="margin:20px;">
                            <div class="dropdown">
                                <button id="GradeButton" class="btn dropdown-toggle" type="button" data-toggle="dropdown">
                                    Select Grade
                                    <span class="caret"></span>
                                </button>
                                <ul class="dropdown-menu" id="GradeList">

                                    <li><a href="#">Select Grade</a></li>
                                    @foreach (var grade in ViewBag.Grades)
                                    {
                                        <li><a href="#">@grade.Title</a></li>
                                    }
                                </ul>
                            </div>
                        </div>


                        <div class="col-md-1 col-md-pull-1" style="margin:20px;">
                            <div class="dropdown">
                                <button id="CourseButton" class="btn dropdown-toggle" type="button" data-toggle="dropdown">
                                    Select Course
                                    <span class="caret"></span>
                                </button>
                                <ul class="dropdown-menu" id="CourseList">
                                    <li><a href="#">Select Course</a></li>
                                    @foreach (var course in ViewBag.Courses)
                                    {
                                        <li><a href="#">@course.Title</a></li>
                                    }
                                </ul>
                            </div>
                        </div>

                        <div class="col-md-1 col-md-push-1" style="margin:20px;">
                            <a id="reset" class="btn btn-primary" role="button">Reset</a>
                        </div>
                    </div>
                </div><br /><br />

                <!-- Method loads the resources initially on the platform-->
                <div id="resource_head" class="row">
                    <!-- Load resources initially-->
                </div>
            </div>

            <div class="col-md-4" style="background-color: rgb(238, 238, 238);">
                @if (ViewBag.displayUpload == "Yes")
                {
                    <!-- Google web fonts -->
                    <link href="https://fonts.googleapis.com/css?family=PT+Sans+Narrow:400,700" rel='stylesheet' />

                    <!-- The main CSS file -->
                    <link href="~/assets/css/style.css" rel="stylesheet" />

                    <!-- JavaScript Includes -->
                    <script src="~/assets/js/jquery.knob.js"></script>

                    <!-- jQuery File Upload Dependencies -->
                    <script src="~/assets/js/jquery.ui.widget.js"></script>
                    <script src="~/assets/js/jquery.iframe-transport.js"></script>
                    <script src="~/assets/js/jquery.fileupload.js"></script>

                    <!-- Our main JS file -->
                    <script src="~/assets/js/script.js"></script>

                    <h2>Upload Corner</h2>
                    <form id="upload" method="post" action="~/Handler1.ashx" enctype="multipart/form-data">

                        <input class="span2" id="GForm" name="GradeType" type="hidden">
                        <input class="span2" id="CForm" name="SubjectType" type="hidden">

                        @*<input class="span2" id="RForm" name="ResourceType" type="hidden">*@


                        <div id="attributes">
                            <div class="alert alert-warning fade in" id="warning" hidden>
                                <strong>Warning!</strong> Please fill in details to proceed...
                            </div>
                            <div class="alert alert-success fade in" id="success" hidden>
                                <strong>Success!</strong> Proceed to selecting files...
                            </div>

                            <h3>Fill Details:</h3>

                            <div class="form-group">
                                <br />
                                <input class="form-control" id="ResourceTitle" name="ResourceTitle" type="text" placeholder="Enter Resource Title">
                                <br />
                                <textarea class="form-control" rows="6" id="ResourceDescription" name="ResourceDescription" placeholder="Enter Resource Description... (upto 255 characters) Accepted Formats: Common images, videos, audio, pdf, documents:Eg. Excel, Word, Powerpoint, Flash, Compressed: Eg. *.rar, *.zip, *.ubz For all other unaccepted formats please upload as zip / compressed file"></textarea>

                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="dropdown">
                                        <button id="GUplBut" class="btn dropdown-toggle" type="button" data-toggle="dropdown">
                                            Select Grade
                                            <span class="caret"></span>
                                        </button>
                                        <ul class="dropdown-menu" id="GradeUpload">
                                            @foreach (var grade in ViewBag.Grades)
                                            {
                                                <li><a>@grade.Title</a></li>
                                            }
                                        </ul>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="dropdown">
                                        <button id="CUplBut" class="btn dropdown-toggle" type="button" data-toggle="dropdown">
                                            Select Course
                                            <span class="caret"></span>
                                        </button>
                                        <ul class="dropdown-menu" id="CourseUpload">
                                            @foreach (var course in ViewBag.Courses)
                                            {
                                                <li><a>@course.Title</a></li>
                                            }
                                        </ul>
                                    </div>
                                </div>
                            </div>
                            <br />
                            <label>Click <a onclick="showUploadAgreement(this);" href="javascript:void(0);">here </a>to read the upload agreement</label>
                            <br />
                            <!--<label>@Html.CheckBox("uploadAgreement", false) I agree to upload the resource under the Creative Commons License</label>-->
                            <label><input type="checkbox" id="uploadAgreementNotChecked" /> I agree to upload the resource under the Creative Commons License</label>
                            <br />
                            <br />
                            <div class="form-group">
                                <button type="button" class="btn btn-primary" onclick="validateForm()">Validate Details</button>
                            </div>
                            <br />
                        </div>
                        <div id="drop">
                            Drop Here
                            <a>Browse</a>
                            <input type="file" accept="image/*,audio/*,video/*,*.7z,*.cbr,*.deb,*.gz,*.pkg,*.rar,*.rpm,*.sitx,*.tar.gz,*.zip,*.zipx,application/pdf,application/vnd.ms-powerpoint,application/vnd.openxmlformats-officedocument.presentationml.slideshow,application/vnd.openxmlformats-officedocument.presentationml.presentation" name="upl" id="fileupload" multiple />
                        </div>
                        <ul>
                            <!-- The file uploads will be shown here -->
                        </ul>
                    </form>
                }
            </div>
        </div>
    </div>

    <!--This is the checkbox dialog if the upload agreement checkbox is not checked-->
    <div class="modal fade bootstrapNotChecked" id="agreementNotChecked">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-body">
                    <label>Please tick to confirm that you have read the upload agreement and agreed to upload the resource under 
                    the Creative Commons License.</label>
                    <button class="btn btn-success" data-dismiss="modal">Ok</button>
                    <button class="btn btn-danger" data-dismiss="modal">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!--This is the checkbox dialog if the upload agreement checkbox is not checked end-->

    <!--This is the upload agreement dialog box-->

    <!--Button to enable / show the upload agreement dialog-->

    <!--<a id="uploadAgreementButton" class="btn btn-success" data-toggle="modal" data-target=".bootstrapToggle"><span class="glyphicon glyphicon-eye-close"></span>
        Show Dialog Modal
    </a>
    -->

    <div class="modal fade bootstrapToggle" id="uploadAgreementDialog">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>Upload agreement</h3>
                </div>
                <div class="modal-body">
                    <p>
                        <img src="~/Content/Icons/attribution.png" width="64" height="64" align="left"/><br />
                        <b>Attribution</b> - Users must give you appropriate credit, provide a link to the license, and indicate if changes were made.
                    </p>
                    <p>
                        <img src="~/Content/Icons/non_commercial.png" width="64" height="64" align="left"/>
                        <br />
                        <b>NonCommercial</b> - Users must not use the material for commercial purposes.
                    </p>
                    <p>
                        <img src="~/Content/Icons/share_alike.png" width="64" height="64" align="left"/>
                        <br /><b>ShareAlike</b> - If users remix, transform, or build upon the material, users must distribute your contributions under the same license as the original.
                    </p>

                </div>
            </div>
        </div>
    </div>

    <!--This is the end of the upload agreement dialog box-->

    <!-- This is the feedback button code-->
    <a class="btn btn-success" data-toggle="modal" data-target=".bootstrapmodal"><span class="glyphicon glyphicon-eye-open"></span>
        Write Feedback
    </a>

        <div class="modal fade bootstrapmodal">
            @using (Html.BeginForm("ResourceAbuseDescription", "Home")) { 
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <button data-dismis="modal" class="close"><span>&times;</span></button>
                            <div class="modal-title"><h4>Report Abuse</h4></div>
                        </div>
                        <div class="modal-body">
                            @Html.Label("Resource Title")<span style="color:red"> *</span><p></p><input class="input-sm" placeholder="Resource Title" type="text" name="resourceName" /><br /><br />
                            @Html.Label("Resource Description")<span style="color:red"> *</span><p></p><input class="input-sm" placeholder="Resource Description" type="text" name="resourceDescription" /><br /><br />
                            @Html.Label("Additional Feedback")<p></p><input class="input-sm" placeholder="Feedback" type="text" name="resourceFeedback" /><br /><br />
                        </div>
                        <div class="modal-footer">
                            <input type="submit" class="btn btn-primary" value="Submit" />
                            <button class="btn btn-danger" data-dismiss="modal">Cancel</button>
                        </div>
                    </div>
                </div>
            }
        </div>
        <!-- Feedback button code finished-->
</body>
</html>

<script type="text/javascript">
    function showUploadAgreement() {
        // alert("Hello World Application")
        $('#uploadAgreementDialog').modal('show');
    }
</script>

<script type="text/javascript">
    // Method to fetch resources with filters applied
    function fetch() {
        $("#resource_head").empty();
        $.ajax({
            type: 'GET',
            url: '@Url.Action("QuerySearch")',
            dataType: 'json',
            data: {
                queryName: $("#queryText").val(),
                grade: chosenGrade,
                subject: chosenCourse,
                type: chosenResourceType,
                displayEducatorResources: isToggleChecked
            },
            success: function (data) {
                if (data === "Your query did not return any result.") {
                    // alert(data.responseText);
                    var append_data = $('<h3>Your Query did not return any result</h3>');
                    $("#resource_head").append(append_data);
                }
                else {
                    // var items = '';
                    $.each(data, function (i, item) {
                        var resource_Url = item.ResourceURL;
                        // var resource_url = item.ResourceURL;

                        var append_data = $('<div class="col-md-4">' +
                            '<div class="box">' +
                            '<a href="' + '/Home/ResourceDisplay?ID=' + item.ResourceID + '">' +
                            '<img src="' + item.ResourceThumbnail + '" />' +
                            '</a>' +
                            '<div class="content">' +
                            '<p class="title">' +
                                item.ResourceTitle +
                            '</p>' +
                            '<p class="desc">' +
                                item.ResourceDescription +
                            '</p>' +
                            '<p>' +
                                '<span class="author">Grade : ' + item.ResourceGrades + '</span>' +
                                '<span class="price">' + item.ResourceSubject + '</span>' +
                            '</p>' +
                            '<p>' +
                                '<span class="ratingText">Ratings</span>' +
                                '<span class="downloads">Downloads</span>' +
                            '</p>' +
                            '<p>' +
                            '<span class="ratings">' +
                                '<input id="rating-input" name="rating bar" type="number" class="rating-disabled rating" disabled value="' + item.Ratings + '" data-size="xs" />' +
                            '</span>' +
                            '<span class="downloadsText">(<b>' + item.Downloads + '</b>)</span>' +
                            '</p>' +
                            '</div>' +
                            '<a id="editEducatorResource" ' + visibility + 'href="' + '/Home/EditResource?ID=' + item.ResourceID + '">&nbspEdit' +
                            '</a>' +
                            '<a onClick="deleteResource(' + item.ResourceID + ')" id="deleteEducatorResource" ' + visibility + '">&nbspDelete' +
                            '</a>' +
                            '</div></div>');

                        $("#resource_head").append(append_data);
                    });
                }
                
                $("[name='rating bar']").rating('refresh', { disabled: true, showClear: false, showCaption: false });
                $('#resource_head').data('paginate').kill();
                $('#resource_head').paginate({ perPage: 9, 'autoScroll': false });
                $('#resource_head').data('paginate').switchPage(1);
            },
            error: function (response) {

            }
        });
        return false;
    }

    // Pagination when the resources are loaded on the platform initially.
    $(document).ready(function () {
        // Call the function to populate the resources on the platform returned from JSON
        $('#resource_head').paginate({ perPage: 12, 'autoScroll': false });
        $('#resource_head').data('paginate').switchPage(1);
        $("#btnSubmit").click(fetch)
        fetch();
    });
</script>
<script>
    $("#showUploadedResources").change(function () {
        if (this.checked) {
            isToggleChecked = true;
            visibility = ' style="visibility:visible;" ';
            fetch();
        } else {
            isToggleChecked = false;
            visibility = ' style="visibility:hidden;" ';
            fetch();
        }
    });
</script>
<script type="text/javascript">

    var isToggleChecked = false;
    var visibility = ' style="visibility:hidden;" ';
    var chosenGrade = "";
    var chosenCourse = "";
    var chosenResourceType = "";

    var gradeUpload = "Select Grade";
    var courseUpload = "Select Subject";
    var resourceTypeUpload = "Select Resource Type";
    var resourceDescription = "";
    var resourceTitle = "";

    $("#reset").click(function () {
        chosenGrade = chosenCourse = chosenResourceType = "";
        $('#GradeButton').html("Select Grade");
        $('#CourseButton').html("Select Course");
        $('#queryText').val("");
        fetch();
    })

    $("#drop").click(function () {
        $("#attributes").show();
    })

    //  $("#GradeUpload, #SubjectUpload, #ResourceUpload").change(validateForm);
    $("#GradeUpload li").on('click', function () {

        $('#GUplBut').html($(this).text());
        $('#GForm').val($(this).text());
        gradeUpload = $(this).text();
        //validateForm();
    });

    $("#CourseUpload li").on('click', function () {

        $('#CUplBut').html($(this).text());
        $('#CForm').val($(this).text());
        courseUpload = $(this).text();
        //validateForm();
    });

    function validateForm() {

        if (gradeUpload == "Select Grade" || courseUpload == "Select Subject" || $("#ResourceTitle").val() == "" || $("#ResourceDescription").val() == "") {
            $("#drop").hide();
            $("#success").hide();
            $("#warning").show();
        }
        else {
            $("#warning").hide();
            $("#success").show();
            $("#drop").show();
        }

        // Check if the upload agreement checkbox is not checked
        if ($("#uploadAgreementNotChecked").prop('checked') == false) {
            $('#agreementNotChecked').modal('show');
        }
    }

    $('#GradeList li').on('click', function () {
        $('#GradeButton').html($(this).text());
        chosenGrade = $(this).text();
        fetch();
    });

    $('#CourseList li').on('click', function () {
        $('#CourseButton').html($(this).text());
        chosenCourse = $(this).text();
        fetch();
    });

    $('#ResourceTypeList li').on('click', function () {

        chosenResourceType = $(this).text().valueOf() == new String("All").valueOf() ? "" : $(this).text();
        fetch();
    });

    $(document).ready(function () {
        $("#GradeList, #CourseList, #ResourceType").change(fetch);
        $("#drop, #uploadTbl").hide();
    });

    $(document).ready(function () {
        $("[name='rating bar']").rating('refresh', { disabled: true, showClear: false, showCaption: false });
    });


    function iconType(resource) {
        switch (resource) {
            case 'E-Books': return 'E-Books'; break;
            case 'Image': return 'Image'; break;
            case 'Compressed': return 'Compressed'; break;
            case 'Video': return "Video"; break;
            case 'HTML5': return "HTML5"; break;
            default: return "File";
                break;
        }
    }

    function deleteResource(ID) {
        var r = confirm("Confirm resource deletion?");
        if (r == true) {
            $.ajax({
                url: '@Url.Action("DeleteResource")',
                type: 'POST',
                dataType: 'json',
                data: { ID: ID },
                success: function (result) {
                    // alert(result);
                    fetch();
                },
                error: function () {
                    alert("error");
                }
            });
        } else {
            alert("You pressed Cancel!");
        }
    }

    $(function () {
        $("#deleteEducatorResource").click(function (event) {
            event.preventDefault();
            $('<div title="Confirm"><div>').dialog({
                open: function (event, ui) {
                    $(this).html("Do you want to delete this resource?");
                },
                close: function (event, ui) {
                    $(this).remove();
                },
                resizable: false,
                height: 140,
                modal: true,
                buttons: {
                    'Yes': function () {
                        $(this).dialog('close');
                        $.post('url/thevalue');
                    },
                    'No': function () {
                        $(this).dialog('close');
                        $.post('url/value');
                    }
                }
            });
        });
    });

</script>